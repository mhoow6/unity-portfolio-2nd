using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

[RequireComponent(typeof(SphereCollider),(typeof(Rigidbody)))]
public class Projectile : BaseObject, IPoolable
{
    public void SetData(Character owner, float damageScale)
    {
        m_Owner = owner;
        m_DamageScale = damageScale;
    }

    #region 투사체 발사
    public void ShootStraight(Vector3 direction, float moveSpeed, int lifeTime)
    {
        StartCoroutine(ShootStraightCoroutine(direction, moveSpeed, lifeTime));
    }

    public void ShootParabola(Vector3 startPosition, Vector3 endPosition, float height, float lifeTime)
    {
        StartCoroutine(ShootParabolaCoroutine(startPosition, endPosition, height, lifeTime));
    }
    #endregion

    #region 오브젝트 풀링
    public bool Poolable { get => m_Poolable; set => m_Poolable = value; }
    public void OnLoad()
    {
        gameObject.SetActive(true);
    }

    public void OnRelease()
    {
        StopAllCoroutines();
        gameObject.SetActive(false);
    }
    #endregion

    // -----------------------------------------------------------------------

    protected Character m_Owner;

    #region 충돌 판정
    protected void OnTriggerEnter(Collider other)
    {
        // 지형 충돌시 풀에게 자기 반환
        if (other.gameObject.layer == GameManager.GameDevelopSettings.TerrainLayermask)
        {
            StageManager.Instance.PoolSystem.Release(this);
            return;
        }

        // 캐릭터와 충돌시
        var rhs = other.GetComponent<Character>();
        if (rhs != null && !other.CompareTag(m_Owner.tag))
        {
            var result = m_Owner.CalcuateDamage(rhs, m_DamageScale);

            // 실제 데미지
            DamagedParam param = new DamagedParam()
            {
                Attacker = m_Owner,
                Damage = result.Damage,
                IsCrit = result.IsCrit,
            };

            rhs.Damaged(param);

            OnCollide(other);

            // 풀에게 자기 반환
            StageManager.Instance.PoolSystem.Release(this);
        }
    }
    protected virtual void OnCollide(Collider other) { }
    #endregion

    // -----------------------------------------------------------------------

    [SerializeField] Rigidbody m_RigidBody;
    [SerializeField] SphereCollider m_SphereCollider;

    float m_DamageScale;

    const float SHOOT_VELOCITY = 2f;

    #region 투사체 발사
    IEnumerator ShootStraightCoroutine(Vector3 direction, float moveSpeed, int lifeTime)
    {
        float timer = 0f;
        while (timer < lifeTime)
        {
            timer += Time.deltaTime;

            transform.position += direction * moveSpeed * Time.deltaTime;

            yield return null;
        }
        StageManager.Instance.PoolSystem.Release(this);
    }

    IEnumerator ShootParabolaCoroutine(Vector3 startPosition, Vector3 endPosition, float height, float lifeTime)
    {
        float timer = 0f;
        while (timer < lifeTime)
        {
            timer += Time.deltaTime;

            transform.position = MathParabola.Parabola(startPosition, endPosition, height, timer / lifeTime);

            yield return null;
        }
        StageManager.Instance.PoolSystem.Release(this);
    }
    #endregion

    #region 오브젝트 풀링
    bool m_Poolable;
    #endregion
}

/// <summary> 투사체 궤적 타입 </summary>
public enum TrajectoryType
{
    /// <summary> 직선 </summary>
    Straight,
    /// <summary> 포물선 </summary>
    Parabola
}
